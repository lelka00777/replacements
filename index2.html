<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Å–º–µ–Ω</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
            padding: 0.5rem;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        #employees-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .employee-card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            padding: 0.75rem;
        }
        .profile-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .profile-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #3b82f6;
        }
        .profile-name {
            font-size: 1rem;
            font-weight: 700;
        }
        .profile-position {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .section-title {
            font-size: 0.9rem;
            font-weight: 700;
            margin-top: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .session-block {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            position: relative;
        }
        .session-block .input-group {
            display: flex;
            gap: 0.5rem;
        }
        .session-block input {
            flex: 1;
            padding: 0.4rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            font-size: 0.8rem;
        }
        .session-block .remove-btn {
            background-color: #ef4444;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            line-height: 1;
            font-size: 0.75rem;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .session-block .main-inputs {
            display: flex;
            gap: 0.5rem;
        }
        .session-block .main-inputs input {
            flex: 1;
        }
        .btn-add, .btn-calculate {
            padding: 0.4rem 0.8rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            font-size: 0.8rem;
        }
        .btn-add {
            background-color: #e5e7eb;
            color: #4b5563;
        }
        .btn-add:hover {
            background-color: #d1d5db;
        }
        .btn-calculate, #load-data-btn {
            background-color: #3b82f6;
            color: white;
        }
        .btn-calculate:hover, #load-data-btn:hover {
            background-color: #2563eb;
        }
        .results-section {
            margin-top: 0.75rem;
            border-top: 1px solid #e5e7eb;
            padding-top: 0.75rem;
        }
        .results-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .results-section li {
            background-color: #f9fafb;
            padding: 0.4rem;
            border-radius: 0.5rem;
            margin-bottom: 0.25rem;
            font-size: 0.8rem;
        }
        .results-title-container {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 0.5rem;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.open {
            visibility: visible;
            opacity: 1;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 400px;
            text-align: center;
            position: relative;
        }
        #load-data-modal .modal-content {
            text-align: left;
        }
        #load-data-modal textarea {
            width: 100%;
            height: 200px;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.5rem;
            font-family: monospace;
            font-size: 0.8rem;
        }
        .modal-close-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }
        .alert-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            text-align: center;
        }
        .session-block.conflict input {
            border-color: #ef4444;
            border-width: 2px;
        }
        .conflict-label {
            display: inline-block;
            background-color: #ef4444;
            color: white;
            padding: 2px 6px;
            border-radius: 5px;
            font-size: 0.7rem;
            white-space: nowrap;
            cursor: pointer;
            margin-left: 0.5rem;
        }
        .conflict-options-modal .modal-content {
            max-width: 500px;
            text-align: left;
        }
        .conflict-options-modal ul {
            list-style: none;
            padding: 0;
        }
        .conflict-options-modal li {
            background-color: #f3f4f6;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .conflict-options-modal li:hover {
            background-color: #e5e7eb;
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="text-xl font-bold text-center mb-4">–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Å–º–µ–Ω</h1>
    <div id="employees-container">
        <!-- Employee cards will be generated here -->
    </div>
    <div class="flex justify-center mt-4 gap-2">
        <button id="add-employee-btn" class="btn-add">–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</button>
        <button id="clear-all-btn" class="btn-add">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
        <button id="load-data-btn" class="btn-calculate">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
    </div>
</div>

<div id="share-modal" class="modal">
    <div class="modal-content">
        <span class="modal-close-btn">&times;</span>
        <h3 class="text-lg font-bold mb-4">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ—Ç–ø—Ä–∞–≤–∫–∏</h3>
        <div class="flex flex-col gap-4">
            <button id="share-image-btn" class="btn-add bg-blue-500 text-white">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
            <button id="share-text-btn" class="btn-add bg-blue-500 text-white">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–∞–∫ —Ç–µ–∫—Å—Ç</button>
        </div>
    </div>
</div>

<div id="load-data-modal" class="modal">
    <div class="modal-content">
        <span class="modal-close-btn">&times;</span>
        <h3 class="text-lg font-bold mb-4">–í—Å—Ç–∞–≤—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</h3>
        <textarea id="data-input" placeholder="–ü—Ä–∏–º–µ—Ä:&#10;üë§ –£–ª—å—è–Ω–∞ (–°–∫–∞–Ω 1): 11:50-12:20, 15:00-16:00"></textarea>
        <div class="flex justify-end mt-4">
            <button id="parse-data-btn" class="btn-calculate">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å</button>
        </div>
    </div>
</div>

<div id="session-options-modal" class="modal conflict-options-modal">
    <div class="modal-content">
        <span class="modal-close-btn">&times;</span>
        <h3 class="text-lg font-bold mb-4" id="session-options-title">–î–µ–π—Å—Ç–≤–∏—è —Å —Å–µ—Å—Å–∏–µ–π</h3>
        <p class="text-sm text-gray-600 mb-4" id="session-options-text"></p>
        <div id="session-options-list">
            <!-- Solutions will be dynamically inserted here -->
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const employeesContainer = document.getElementById('employees-container');
        const addEmployeeBtn = document.getElementById('add-employee-btn');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const loadDataBtn = document.getElementById('load-data-btn');
        const shareModal = document.getElementById('share-modal');
        const shareImageBtn = document.getElementById('share-image-btn');
        const shareTextBtn = document.getElementById('share-text-btn');
        const loadDataModal = document.getElementById('load-data-modal');
        const dataInput = document.getElementById('data-input');
        const parseDataBtn = document.getElementById('parse-data-btn');
        const sessionOptionsModal = document.getElementById('session-options-modal');
        const sessionOptionsList = document.getElementById('session-options-list');
        const sessionOptionsTitle = document.getElementById('session-options-title');
        const sessionOptionsText = document.getElementById('session-options-text');

        let currentEmployeeIndex = null;
        let employeeData = [];

        const savedData = localStorage.getItem('employeeSchedules');
        if (savedData) {
            employeeData = JSON.parse(savedData);
        } else {
            employeeData = [
                {
                    name: "–í–ª–∞–¥",
                    position: "–î–≤–µ—Ä—å",
                    image: "https://placehold.co/120x120/E8D2FF/9400D3?text=–í–ª–∞–¥",
                    sessions: []
                },
                {
                    name: "–ö—Å—é—à–∞",
                    position: "Welcome",
                    image: "https://placehold.co/120x120/FFD2F5/A6428B?text=–ö—Å—é—à–∞",
                    sessions: []
                }
            ];
        }
        
        function hasConflict(employeeSessions, sessionStart, sessionEnd, ignoreIndex) {
            const proposedStart = new Date(`2000-01-01T${sessionStart}`);
            const proposedEnd = new Date(`2000-01-01T${sessionEnd}`);

            if (proposedEnd <= proposedStart) {
                return true;
            }

            for (let i = 0; i < employeeSessions.length; i++) {
                if (i === ignoreIndex) continue;
                const existingStart = new Date(`2000-01-01T${employeeSessions[i].start}`);
                const existingEnd = new Date(`2000-01-01T${employeeSessions[i].end}`);
                
                if (proposedStart < existingEnd && proposedEnd > existingStart) {
                    return true;
                }
            }
            return false;
        }

        function checkAndMarkAllConflicts() {
            employeeData.forEach(employee => {
                employee.sessions.forEach((session, sessionIndex) => {
                    if (session.resolved) {
                        session.conflict = false;
                        return;
                    }
                    const has_conflict = hasConflict(employee.sessions, session.start, session.end, sessionIndex);
                    session.conflict = has_conflict;
                });
            });
        }
        
        function renderEmployees() {
            employeesContainer.innerHTML = '';
            checkAndMarkAllConflicts();
            employeeData.forEach((employee, employeeIndex) => {
                const card = document.createElement('div');
                card.classList.add('employee-card');
                card.id = `employee-card-${employeeIndex}`;

                const profileHeader = `
                    <div class="profile-header">
                        <img src="${employee.image}" alt="–ü—Ä–æ—Ñ–∏–ª—å ${employee.name}" class="profile-img">
                        <div>
                            <input type="text" value="${employee.name}" class="profile-name bg-transparent border-none focus:outline-none w-full" data-employee-index="${employeeIndex}" data-field="name">
                            <input type="text" value="${employee.position}" class="profile-position bg-transparent border-none focus:outline-none w-full" data-employee-index="${employeeIndex}" data-field="position">
                        </div>
                    </div>
                `;
                card.innerHTML = profileHeader;

                const scheduleSection = document.createElement('div');
                scheduleSection.classList.add('schedule-section');

                const sessionsTitle = document.createElement('h4');
                sessionsTitle.classList.add('section-title');
                sessionsTitle.textContent = "–†–∞–±–æ—á–∏–µ —Å–µ—Å—Å–∏–∏";
                scheduleSection.appendChild(sessionsTitle);

                const sessionsContainer = document.createElement('div');
                sessionsContainer.id = `sessions-container-${employeeIndex}`;

                employee.sessions.forEach((session, sessionIndex) => {
                    const sessionBlock = createSessionBlock(employeeIndex, sessionIndex, session.start, session.end, session.replacement, session.conflict);
                    sessionsContainer.appendChild(sessionBlock);
                });
                scheduleSection.appendChild(sessionsContainer);

                const buttonsDiv = document.createElement('div');
                buttonsDiv.classList.add('flex', 'gap-2', 'mt-2', 'mb-2');
                const addSessionBtn = document.createElement('button');
                addSessionBtn.classList.add('btn-add');
                addSessionBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å';
                addSessionBtn.addEventListener('click', () => {
                    employeeData[employeeIndex].sessions.push({ start: "", end: "", replacement: "", conflict: false });
                    saveDataAndRender();
                });
                buttonsDiv.appendChild(addSessionBtn);

                const calculateBtn = document.createElement('button');
                calculateBtn.classList.add('btn-calculate');
                calculateBtn.textContent = '–†–∞—Å—Å—á–∏—Ç–∞—Ç—å';
                calculateBtn.addEventListener('click', () => {
                    saveData();
                    calculateAndDisplay(employeeData[employeeIndex], employeeIndex);
                });
                buttonsDiv.appendChild(calculateBtn);

                const shareBtn = document.createElement('button');
                shareBtn.classList.add('btn-add', 'bg-blue-500', 'text-white');
                shareBtn.textContent = '–ü–æ–¥–µ–ª–∏—Ç—å—Å—è';
                shareBtn.addEventListener('click', () => {
                    currentEmployeeIndex = employeeIndex;
                    shareModal.classList.add('open');
                });
                buttonsDiv.appendChild(shareBtn);

                scheduleSection.appendChild(buttonsDiv);

                const resultsSection = document.createElement('div');
                resultsSection.id = `results-section-${employeeIndex}`;
                resultsSection.classList.add('results-section');
                scheduleSection.appendChild(resultsSection);

                card.appendChild(scheduleSection);
                employeesContainer.appendChild(card);
                
                calculateAndDisplay(employee, employeeIndex);
            });

            document.querySelectorAll('input[data-field]').forEach(input => {
                input.addEventListener('change', (e) => {
                    const empIdx = e.target.dataset.employeeIndex;
                    const field = e.target.dataset.field;
                    employeeData[empIdx][field] = e.target.value;
                    saveDataAndRender();
                });
            });
        }

        function createSessionBlock(employeeIndex, sessionIndex, startValue, endValue, replacementValue, isConflicted) {
            const sessionBlock = document.createElement('div');
            sessionBlock.classList.add('session-block');
            
            const conflictLabel = isConflicted ? `<span class="conflict-label">–ö–æ–Ω—Ñ–ª–∏–∫—Ç!</span>` : '';
            if (isConflicted) {
                sessionBlock.classList.add('conflict');
            }

            sessionBlock.innerHTML = `
                <div class="input-group">
                    <input type="time" class="session-start" value="${startValue || ""}" data-employee-index="${employeeIndex}" data-session-index="${sessionIndex}">
                    <input type="time" class="session-end" value="${endValue || ""}" data-employee-index="${employeeIndex}" data-session-index="${sessionIndex}">
                </div>
                <div class="input-group">
                    <input type="text" class="session-replacement" value="${replacementValue || ""}" placeholder="–ó–∞–º–µ–Ω—è–µ—Ç..." data-employee-index="${employeeIndex}" data-session-index="${sessionIndex}">
                    <button class="remove-btn" data-employee-index="${employeeIndex}" data-session-index="${sessionIndex}">X</button>
                    ${conflictLabel}
                </div>
            `;
            const removeBtn = sessionBlock.querySelector('.remove-btn');
            removeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                employeeData[employeeIndex].sessions.splice(sessionIndex, 1);
                saveDataAndRender();
            });

            sessionBlock.addEventListener('click', (e) => {
                e.stopPropagation();
                showSessionOptions(employeeIndex, sessionIndex);
            });

            const inputs = sessionBlock.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('change', (e) => {
                    const empIdx = e.target.dataset.employeeIndex;
                    const sessIdx = e.target.dataset.sessionIndex;
                    if (e.target.classList.contains('session-start')) {
                        employeeData[empIdx].sessions[sessIdx].start = e.target.value;
                    } else if (e.target.classList.contains('session-end')) {
                        employeeData[empIdx].sessions[sessIdx].end = e.target.value;
                    } else if (e.target.classList.contains('session-replacement')) {
                        employeeData[empIdx].sessions[sessIdx].replacement = e.target.value;
                    }
                    employeeData[empIdx].sessions[sessIdx].resolved = false;
                    saveDataAndRender();
                });
            });
            return sessionBlock;
        }

        function calculateAndDisplay(employee, employeeIndex) {
            const resultsSection = document.getElementById(`results-section-${employeeIndex}`);
            const workStart = new Date(`2000-01-01T09:45:00`);
            const workEnd = new Date(`2000-01-01T22:45:00`);

            let totalWorkMinutes = 0;
            let totalBreakMinutes = 0;
            const breakDetails = [];
            const workDetails = [];
            
            const sortedSessions = [...employee.sessions].filter(s => s.start && s.end).sort((a, b) => {
                return a.start.localeCompare(b.start);
            });

            sortedSessions.forEach((session, index) => {
                const start = new Date(`2000-01-01T${session.start}:00`);
                const end = new Date(`2000-01-01T${session.end}:00`);
                
                const workMinutes = (end - start) / (1000 * 60);
                if (workMinutes > 0) {
                    totalWorkMinutes += workMinutes;
                    workDetails.push({ start: session.start, end: session.end, duration: workMinutes, replacement: session.replacement });
                }

                if (index > 0) {
                    const prevEnd = new Date(`2000-01-01T${sortedSessions[index - 1].end}:00`);
                    const breakMinutes = (start - prevEnd) / (1000 * 60);
                    if (breakMinutes > 0) {
                        breakDetails.push({
                            start: sortedSessions[index - 1].end,
                            end: session.start,
                            duration: breakMinutes
                        });
                    }
                }
            });

            if (sortedSessions.length > 0) {
                const firstSessionStart = new Date(`2000-01-01T${sortedSessions[0].start}:00`);
                const lastSessionEnd = new Date(`2000-01-01T${sortedSessions[sortedSessions.length - 1].end}:00`);

                if (firstSessionStart > workStart) {
                    const beforeWorkBreak = (firstSessionStart - workStart) / (1000 * 60);
                    if (beforeWorkBreak > 0) {
                         breakDetails.push({
                            start: "09:45",
                            end: sortedSessions[0].start,
                            duration: beforeWorkBreak
                         });
                    }
                }

                if (lastSessionEnd < workEnd) {
                    const afterWorkBreak = (workEnd - lastSessionEnd) / (1000 * 60);
                    if (afterWorkBreak > 0) {
                        breakDetails.push({
                            start: sortedSessions[sortedSessions.length - 1].end,
                            end: "22:45",
                            duration: afterWorkBreak
                        });
                    }
                }
            } else {
                 const fullBreak = (workEnd - workStart) / (1000 * 60);
                 if (fullBreak > 0) {
                     breakDetails.push({
                         start: "09:45",
                         end: "22:45",
                         duration: fullBreak
                     });
                 }
            }

            totalBreakMinutes = breakDetails.reduce((sum, b) => sum + b.duration, 0);

            resultsSection.innerHTML = `
                <div class="results-title-container">
                    <h4 class="section-title">–ó–∞–Ω—è—Ç–æ:</h4>
                    <span>${totalWorkMinutes} –º–∏–Ω</span>
                </div>
                <ul>
                    ${workDetails.map(d => `<li>${d.start} - ${d.end} / ${d.replacement}</li>`).join('')}
                </ul>
                
                <div class="results-title-container">
                    <h4 class="section-title">–°–≤–æ–±–æ–¥–Ω–æ:</h4>
                    <span>${totalBreakMinutes} –º–∏–Ω</span>
                </div>
                <ul>
                    ${breakDetails.sort((a, b) => a.start.localeCompare(b.start)).map(b => `<li>${b.start} - ${b.end} (${b.duration} –º–∏–Ω)</li>`).join('')}
                </ul>
            `;
        }

        function saveData() {
            try {
                localStorage.setItem('employeeSchedules', JSON.stringify(employeeData));
            } catch (e) {
                console.error('Failed to save data:', e);
            }
        }

        function saveDataAndRender() {
            saveData();
            renderEmployees();
        }
        
        function showCustomAlert(message) {
            const alertPopup = document.createElement('div');
            alertPopup.className = 'alert-popup';
            alertPopup.innerHTML = `
                <p>${message}</p>
                <button onclick="this.parentNode.remove()" style="padding: 8px 16px; margin-top: 15px; border-radius: 5px; border: 1px solid #ccc; cursor: pointer;">–û–ö</button>
            `;
            document.body.appendChild(alertPopup);
        }

        function shareAsImage(employeeIndex) {
            const cardElement = document.getElementById(`employee-card-${employeeIndex}`);
            if (!cardElement) return;

            html2canvas(cardElement, {
                useCORS: true,
                backgroundColor: null,
            }).then(canvas => {
                canvas.toBlob(function(blob) {
                    const file = new File([blob], "schedule.png", {type: "image/png"});
                    const filesArray = [file];
                    if (navigator.canShare && navigator.canShare({ files: filesArray })) {
                        navigator.share({
                            files: filesArray,
                            title: '–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞',
                            text: '–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –º–æ–π –≥—Ä–∞—Ñ–∏–∫!'
                        }).then(() => {
                            console.log('Share successful');
                        }).catch((error) => {
                            console.error('Share failed', error);
                        });
                    } else {
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = `schedule_${employeeData[employeeIndex].name}.png`;
                        link.click();
                        URL.revokeObjectURL(link.href);
                    }
                }, 'image/png');
        
                shareModal.classList.remove('open');
            }).catch(e => {
                console.error("Failed to capture image for sharing:", e);
                const message = "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏. –í–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞.";
                showCustomAlert(message);
            });
        }

        function shareAsText(employeeIndex) {
            const employee = employeeData[employeeIndex];
            if (!employee) return;

            const workStart = new Date(`2000-01-01T09:45:00`);
            const workEnd = new Date(`2000-01-01T22:45:00`);

            let totalWorkMinutes = 0;
            let totalBreakMinutes = 0;
            const breakDetails = [];
            const sortedSessions = [...employee.sessions].filter(s => s.start && s.end).sort((a, b) => {
                return a.start.localeCompare(b.start);
            });
            const workDetails = sortedSessions.map(session => {
                const start = new Date(`2000-01-01T${session.start}:00`);
                const end = new Date(`2000-01-01T${session.end}:00`);
                const workMinutes = (end - start) / (1000 * 60);
                if (workMinutes > 0) totalWorkMinutes += workMinutes;
                return {
                    start: session.start,
                    end: session.end,
                    replacement: session.replacement
                };
            });

            if (sortedSessions.length > 0) {
                const firstSessionStart = new Date(`2000-01-01T${sortedSessions[0].start}:00`);
                const lastSessionEnd = new Date(`2000-01-01T${sortedSessions[sortedSessions.length - 1].end}:00`);

                if (firstSessionStart > workStart) {
                    const beforeWorkBreak = (firstSessionStart - workStart) / (1000 * 60);
                    if (beforeWorkBreak > 0) {
                         breakDetails.push({
                            start: "09:45",
                            end: sortedSessions[0].start,
                            duration: beforeWorkBreak
                         });
                    }
                }

                if (lastSessionEnd < workEnd) {
                    const afterWorkBreak = (workEnd - lastSessionEnd) / (1000 * 60);
                    if (afterWorkBreak > 0) {
                        breakDetails.push({
                            start: sortedSessions[sortedSessions.length - 1].end,
                            end: "22:45",
                            duration: afterWorkBreak
                        });
                    }
                }
            } else {
                 const fullBreak = (workEnd - workStart) / (1000 * 60);
                 if (fullBreak > 0) {
                     breakDetails.push({
                         start: "09:45",
                         end: "22:45",
                         duration: fullBreak
                     });
                 }
            }
            
            for (let i = 0; i < sortedSessions.length - 1; i++) {
                const prevEnd = new Date(`2000-01-01T${sortedSessions[i].end}:00`);
                const nextStart = new Date(`2000-01-01T${sortedSessions[i+1].start}:00`);
                const breakMinutes = (nextStart - prevEnd) / (1000 * 60);
                if (breakMinutes > 0) {
                    breakDetails.push({
                        start: sortedSessions[i].end,
                        end: sortedSessions[i+1].start,
                        duration: breakMinutes
                    });
                }
            }

            totalBreakMinutes = breakDetails.reduce((sum, b) => sum + b.duration, 0);
            
            let textToCopy = `‚è∞ –ì—Ä–∞—Ñ–∏–∫ —Å–º–µ–Ω (${employee.name})\n\n`;
            textToCopy += `‚úÖ –ó–∞–Ω—è—Ç–æ: ${totalWorkMinutes} –º–∏–Ω\n`;
            workDetails.forEach(d => {
                textToCopy += `    ${d.start} - ${d.end} / ${d.replacement}\n`;
            });
            textToCopy += `\nüõãÔ∏è –°–≤–æ–±–æ–¥–Ω–æ: ${totalBreakMinutes} –º–∏–Ω\n`;
            
            breakDetails.sort((a, b) => a.start.localeCompare(b.start));
            
            breakDetails.forEach(b => {
                textToCopy += `    ${b.start} - ${b.end} (${b.duration} –º–∏–Ω)\n`;
            });

            if (navigator.canShare && navigator.canShare({ text: textToCopy })) {
                navigator.share({
                    text: textToCopy
                }).then(() => {
                    console.log('Share successful');
                }).catch((error) => {
                    console.error('Share failed', error);
                    fallbackCopyTextToClipboard(textToCopy);
                });
            } else {
                fallbackCopyTextToClipboard(textToCopy);
            }
            shareModal.classList.remove('open');
        }

        function fallbackCopyTextToClipboard(text) {
            let textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.width = "2em";
            textArea.style.height = "2em";
            textArea.style.padding = "0";
            textArea.style.border = "none";
            textArea.style.outline = "none";
            textArea.style.boxShadow = "none";
            textArea.style.background = "transparent";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                let successful = document.execCommand('copy');
                if (successful) {
                    showCustomAlert("–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!");
                } else {
                    showCustomAlert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é.");
                }
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                showCustomAlert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é.");
            }
            document.body.removeChild(textArea);
        }
        
        loadDataBtn.addEventListener('click', () => {
            loadDataModal.classList.add('open');
            dataInput.value = "";
        });

        parseDataBtn.addEventListener('click', () => {
            const rawData = dataInput.value;
            if (!rawData) {
                showCustomAlert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—Å—Ç–∞–≤—å—Ç–µ –¥–∞–Ω–Ω—ã–µ.");
                return;
            }
            
            employeeData.forEach(employee => {
                employee.sessions = [];
            });
            
            let allSessions = [];
            const lines = rawData.split('\n');
            lines.forEach(line => {
                if (line.includes('–Ω–µ—Ç –ø–µ—Ä–µ—Ä—ã–≤–æ–≤') || !line.includes(':') || !line.includes('üë§')) return;

                const parts = line.split(':');
                const header = parts[0].trim().replace('üë§', '').trim();
                const sessionsText = parts.slice(1).join(':').trim();

                let replacementText = header;
                const nameMatch = header.match(/(.+?)\s*\((.+)\)/);
                if (nameMatch) {
                    replacementText = `${nameMatch[1].trim()} (${nameMatch[2].trim()})`;
                }

                sessionsText.split(',').forEach(s => {
                    const timeRange = s.trim();
                    const [start, end] = timeRange.split('-');
                    if (start && end) {
                        allSessions.push({
                            start: start.trim(),
                            end: end.trim(),
                            replacement: replacementText,
                            conflict: false
                        });
                    }
                });
            });

            if (allSessions.length === 0) {
                showCustomAlert("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ–æ—Ä–º–∞—Ç –≤–µ—Ä–Ω—ã–π.");
                return;
            }
            
            const employeesWithWorkload = employeeData.map((employee, index) => ({
                ...employee,
                index: index,
                minutes: 0
            }));

            if (employeesWithWorkload.length === 0) {
                 showCustomAlert("–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ –∏—Ö –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.");
                 return;
            }

            allSessions.sort((a, b) => a.start.localeCompare(b.start));
            
            allSessions.forEach(session => {
                const start = new Date(`2000-01-01T${session.start}:00`);
                const end = new Date(`2000-01-01T${session.end}:00`);
                const duration = (end - start) / (1000 * 60);

                const sortedEmployees = [...employeesWithWorkload].sort((a, b) => a.minutes - b.minutes);
                const targetEmployee = sortedEmployees[0];

                employeeData[targetEmployee.index].sessions.push(session);
                
                const originalEmployeeObject = employeesWithWorkload.find(e => e.index === targetEmployee.index);
                if (originalEmployeeObject) {
                    originalEmployeeObject.minutes += duration;
                }
            });
            
            saveDataAndRender();
            loadDataModal.classList.remove('open');
            showCustomAlert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –µ—Å—Ç—å –ª–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã, –ø–æ–¥—Å–≤–µ—á–µ–Ω–Ω—ã–µ –∫—Ä–∞—Å–Ω—ã–º.");
        });

        function showSessionOptions(employeeIndex, sessionIndex) {
            const currentSession = employeeData[employeeIndex].sessions[sessionIndex];
            const currentEmployee = employeeData[employeeIndex];
            const originalReplacement = currentSession.replacement;
            const originalDuration = (new Date(`2000-01-01T${currentSession.end}`) - new Date(`2000-01-01T${currentSession.start}`)) / (1000 * 60);
            
            sessionOptionsList.innerHTML = '';
            
            const isConflicted = currentSession.conflict;

            sessionOptionsTitle.textContent = isConflicted ? "–†–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞" : "–î–µ–π—Å—Ç–≤–∏—è —Å —Å–µ—Å—Å–∏–µ–π";
            sessionOptionsText.textContent = isConflicted ? "–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏." : "–í—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Å–µ—Å—Å–∏—é.";

            const addSolution = (description, action) => {
                const li = document.createElement('li');
                li.textContent = description;
                li.addEventListener('click', () => {
                    action();
                    sessionOptionsModal.classList.remove('open');
                });
                sessionOptionsList.appendChild(li);
            };

            // Option 1: Keep as is (only if there is a conflict)
            if (isConflicted) {
                addSolution(`–û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å`, () => {
                    employeeData[employeeIndex].sessions[sessionIndex].resolved = true;
                    employeeData[employeeIndex].sessions[sessionIndex].conflict = false;
                    saveDataAndRender();
                    showCustomAlert(`–ö–æ–Ω—Ñ–ª–∏–∫—Ç –¥–ª—è —Å–º–µ–Ω—ã ${originalReplacement} –±—ã–ª –æ—Å—Ç–∞–≤–ª–µ–Ω –∫–∞–∫ –µ—Å—Ç—å.`);
                });
            }

            // Option 2: Find next available slot for current employee (iterative search)
            const findNextAvailableTime = (start, direction) => {
                let currentStart = new Date(`2000-01-01T${start}`);
                let iterations = 0;
                while (iterations < 50) {
                    currentStart.setMinutes(currentStart.getMinutes() + direction * 15);
                    const newStartStr = `${String(currentStart.getHours()).padStart(2, '0')}:${String(currentStart.getMinutes()).padStart(2, '0')}`;
                    const newEnd = new Date(currentStart);
                    newEnd.setMinutes(newEnd.getMinutes() + originalDuration);
                    const newEndStr = `${String(newEnd.getHours()).padStart(2, '0')}:${String(newEnd.getMinutes()).padStart(2, '0')}`;
                    
                    if (newStartStr > '09:45' && newEndStr < '22:45' && !hasConflict(currentEmployee.sessions, newStartStr, newEndStr, sessionIndex)) {
                        return { start: newStartStr, end: newEndStr };
                    }
                    iterations++;
                }
                return null;
            };

            const forwardSolution = findNextAvailableTime(currentSession.start, 1);
            if (forwardSolution) {
                addSolution(`–°–¥–≤–∏–Ω—É—Ç—å –Ω–∞ ${forwardSolution.start}-${forwardSolution.end} (–≤–ø–µ—Ä–µ–¥)`, () => {
                    employeeData[employeeIndex].sessions[sessionIndex].start = forwardSolution.start;
                    employeeData[employeeIndex].sessions[sessionIndex].end = forwardSolution.end;
                    employeeData[employeeIndex].sessions[sessionIndex].resolved = true;
                    employeeData[employeeIndex].sessions[sessionIndex].conflict = false;
                    saveDataAndRender();
                    showCustomAlert(`–°–º–µ–Ω–∞ ${originalReplacement} –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –Ω–∞ ${forwardSolution.start}-${forwardSolution.end}`);
                });
            }

            const backwardSolution = findNextAvailableTime(currentSession.start, -1);
            if (backwardSolution) {
                addSolution(`–°–¥–≤–∏–Ω—É—Ç—å –Ω–∞ ${backwardSolution.start}-${backwardSolution.end} (–Ω–∞–∑–∞–¥)`, () => {
                    employeeData[employeeIndex].sessions[sessionIndex].start = backwardSolution.start;
                    employeeData[employeeIndex].sessions[sessionIndex].end = backwardSolution.end;
                    employeeData[employeeIndex].sessions[sessionIndex].resolved = true;
                    employeeData[employeeIndex].sessions[sessionIndex].conflict = false;
                    saveDataAndRender();
                    showCustomAlert(`–°–º–µ–Ω–∞ ${originalReplacement} –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –Ω–∞ ${backwardSolution.start}-${backwardSolution.end}`);
                });
            }

            // Option 3: Find first available slot for a colleague, closest to original time
            const otherEmployees = employeeData.filter((emp, idx) => idx !== employeeIndex);
            
            otherEmployees.forEach((otherEmp, otherEmpIndex) => {
                const colleagueIndex = employeeData.indexOf(otherEmp);
                const workStart = new Date(`2000-01-01T09:45:00`);
                const workEnd = new Date(`2000-01-01T22:45:00`);
                const sessionTime = new Date(`2000-01-01T${currentSession.start}`);

                let foundTime = null;
                let minDiff = Infinity;
                let bestStart = null;
                let checkTime = new Date(workStart);
                while (checkTime < workEnd) {
                    const proposedStartStr = `${String(checkTime.getHours()).padStart(2, '0')}:${String(checkTime.getMinutes()).padStart(2, '0')}`;
                    const proposedEnd = new Date(checkTime);
                    proposedEnd.setMinutes(proposedEnd.getMinutes() + originalDuration);
                    const proposedEndStr = `${String(proposedEnd.getHours()).padStart(2, '0')}:${String(proposedEnd.getMinutes()).padStart(2, '0')}`;
                    
                    if (!hasConflict(otherEmp.sessions, proposedStartStr, proposedEndStr, -1)) {
                         const timeDiff = Math.abs(checkTime.getTime() - sessionTime.getTime());
                         if (timeDiff < minDiff) {
                             minDiff = timeDiff;
                             bestStart = proposedStartStr;
                             foundTime = { start: proposedStartStr, end: proposedEndStr };
                         }
                    }
                    checkTime.setMinutes(checkTime.getMinutes() + 15);
                }
                
                if (foundTime) {
                    addSolution(`–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –Ω–∞ ${otherEmp.name} –Ω–∞ ${foundTime.start}-${foundTime.end}`, () => {
                        employeeData[employeeIndex].sessions.splice(sessionIndex, 1);
                        employeeData[colleagueIndex].sessions.push({
                            start: foundTime.start,
                            end: foundTime.end,
                            replacement: originalReplacement,
                            conflict: false,
                            resolved: true
                        });
                        saveDataAndRender();
                        showCustomAlert(`–°–º–µ–Ω–∞ ${originalReplacement} —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –Ω–∞ ${otherEmp.name} –Ω–∞ ${foundTime.start}-${foundTime.end}.`);
                    });
                }
            });

            sessionOptionsModal.classList.add('open');
        }

        document.querySelectorAll('.modal-close-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                shareModal.classList.remove('open');
                loadDataModal.classList.remove('open');
                sessionOptionsModal.classList.remove('open');
            });
        });

        shareImageBtn.addEventListener('click', () => {
            if (currentEmployeeIndex !== null) {
                shareAsImage(currentEmployeeIndex);
            }
        });

        shareTextBtn.addEventListener('click', () => {
            if (currentEmployeeIndex !== null) {
                shareAsText(currentEmployeeIndex);
            }
        });

        addEmployeeBtn.addEventListener('click', () => {
            const newEmployee = {
                name: "–ù–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫",
                position: "–î–æ–ª–∂–Ω–æ—Å—Ç—å",
                image: "https://placehold.co/120x120/E8E8E8/6B6B6B?text=–ù–°",
                sessions: []
            };
            employeeData.push(newEmployee);
            saveDataAndRender();
        });

        clearAllBtn.addEventListener('click', () => {
            const confirmationPopup = document.createElement('div');
            confirmationPopup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 1000; text-align: center;
            `;
            confirmationPopup.innerHTML = `
                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?</p>
                <div style="margin-top: 15px;">
                    <button id="confirm-yes" style="padding: 8px 16px; margin: 0 5px; border-radius: 5px; border: 1px solid #ccc; cursor: pointer;">–î–∞</button>
                    <button id="confirm-no" style="padding: 8px 16px; margin: 0 5px; border-radius: 5px; border: 1px solid #ccc; cursor: pointer;">–ù–µ—Ç</button>
                </div>
            `;
            document.body.appendChild(confirmationPopup);

            document.getElementById('confirm-yes').onclick = () => {
                localStorage.removeItem('employeeSchedules');
                employeeData = [];
                renderEmployees();
                confirmationPopup.remove();
            };
            document.getElementById('confirm-no').onclick = () => {
                confirmationPopup.remove();
            };
        });
        
        renderEmployees();
    });
</script>

</body>
</html>
